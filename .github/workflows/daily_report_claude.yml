name: Daily AI/IT Stock News Report (Claude)

on:
  workflow_dispatch:
    inputs:
      generate_video:
        description: 'å‹•ç”»ç”Ÿæˆã¾ã§å®Ÿè¡Œ'
        required: false
        type: boolean
        default: true
      generate_slides_only:
        description: 'ã‚¹ãƒ©ã‚¤ãƒ‰ã®ã¿ç”Ÿæˆï¼ˆå‹•ç”»ãªã—ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  daily-report-claude:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      # Claude APIã‚’ä½¿ç”¨ï¼ˆèª¿æŸ»ã¨ç”»åƒç”Ÿæˆä»¥å¤–ï¼‰
      AI_PROVIDER: claude

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: remotion-project/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install requests  # Claude APIç”¨

      - name: Install Node dependencies
        run: npm install
        working-directory: ./remotion-project

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Install Japanese fonts
        run: |
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

      # ===== æƒ…å ±åé›†ï¼ˆGeminiä½¿ç”¨ - RSS/Webæ¤œç´¢ï¼‰ =====
      - name: Fetch news data
        run: |
          python scripts/fetch_data.py
        env:
          TDNET_RSS_URL: ${{ secrets.TDNET_RSS_URL }}

      - name: Fetch stock prices
        run: |
          python scripts/fetch_stock_prices.py

      # ===== ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆClaudeä½¿ç”¨ï¼‰ =====
      - name: Generate Market Analysis Report with Claude
        run: |
          python scripts/analyze_market_claude.py
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Generate Portfolio Impact Report with Claude
        run: |
          python scripts/analyze_portfolio_impact_claude.py
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Set date variable
        if: success()
        run: |
          echo "REPORT_DATE=$(date +'%Y_%m_%d')" >> $GITHUB_ENV
          echo "Report date: $(date +'%Y_%m_%d')"

      - name: Convert Market Report to HTML/PDF
        if: success()
        run: |
          python scripts/convert_report_to_html.py output/market_report.md output/
          mv output/market_report.html output/market_report_${{ env.REPORT_DATE }}.html
          mv output/market_report.pdf output/market_report_${{ env.REPORT_DATE }}.pdf
          echo "âœ“ Market report converted to HTML/PDF"

      - name: Convert Portfolio Impact Report to HTML/PDF
        if: success()
        run: |
          python scripts/convert_report_to_html.py output/portfolio_impact_report.md output/
          mv output/portfolio_impact_report.html output/portfolio_impact_report_${{ env.REPORT_DATE }}.html
          mv output/portfolio_impact_report.pdf output/portfolio_impact_report_${{ env.REPORT_DATE }}.pdf
          echo "âœ“ Portfolio impact report converted to HTML/PDF"

      - name: Copy reports to report directory
        if: success()
        run: |
          mkdir -p report/daily/market
          mkdir -p report/daily/portfolio
          cp output/market_report_${{ env.REPORT_DATE }}.html report/daily/market/
          cp output/portfolio_impact_report_${{ env.REPORT_DATE }}.html report/daily/portfolio/
          echo "âœ“ Reports copied to report directory"

      - name: Convert Market Report to YAML for SlideMovie
        if: success()
        run: |
          python scripts/convert_report_to_yaml.py output/market_report.md inputs/ ${{ env.REPORT_DATE }}
          echo "âœ“ YAML file created for SlideMovie workflow"

      - name: Commit reports
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add report/daily/
          git add inputs/daily_report_${{ env.REPORT_DATE }}.yml
          git diff --staged --quiet || git commit -m "Add daily reports for ${{ env.REPORT_DATE }} (Claude)"
          git pull --rebase origin main || true
          git push origin main

      - name: Send Market Report to Discord
        if: success()
        run: |
          python scripts/send_to_discord.py \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            "ğŸ“Š AI/ITå¸‚å ´ æ—¥æ¬¡æƒ…å‹¢ãƒ¬ãƒãƒ¼ãƒˆ (${{ env.REPORT_DATE }}) - Claudeåˆ†æ" \
            "output/market_report.md" \
            "3066993" \
            "output/market_report_${{ env.REPORT_DATE }}.pdf"

      - name: Wait before sending second report
        if: success()
        run: sleep 5

      - name: Send Portfolio Impact Report to Discord
        if: success()
        run: |
          python scripts/send_to_discord.py \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            "ğŸ’¼ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå½±éŸ¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆ (${{ env.REPORT_DATE }}) - Claudeåˆ†æ" \
            "output/portfolio_impact_report.md" \
            "15844367" \
            "output/portfolio_impact_report_${{ env.REPORT_DATE }}.pdf"

      # ===== ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆï¼ˆClaudeä½¿ç”¨ï¼‰ =====
      - name: Generate Presentation Slides with Claude
        if: success() && (github.event.inputs.generate_video == 'true' || github.event.inputs.generate_slides_only == 'true')
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # ç”»åƒç”Ÿæˆç”¨
        run: |
          PRESENTATION_NAME="AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_${{ env.REPORT_DATE }}"
          echo "PRESENTATION_NAME=$PRESENTATION_NAME" >> $GITHUB_ENV

          # Create directories
          mkdir -p slides images presentations/$PRESENTATION_NAME/images

          # Copy background image to images directory for Marp
          cp assets/images/slideBackground.png images/

          # 1. Create slide from YAML
          python3 scripts/create_slide.py "inputs/daily_report_${{ env.REPORT_DATE }}.yml"

          # 2. Generate image prompts (Geminiä½¿ç”¨ - ç”»åƒç”Ÿæˆ)
          python3 scripts/generate_image_prompts_with_characters.py \
            "slides/${PRESENTATION_NAME}_slide.md" \
            --output "slides/${PRESENTATION_NAME}_imageprompt.csv"

          # 3. Generate images (Geminiä½¿ç”¨ - ç”»åƒç”Ÿæˆ)
          python3 scripts/generate_images_from_prompts.py \
            "slides/${PRESENTATION_NAME}_imageprompt.csv" \
            --output-dir "images"

          # 4. Insert images into slides
          python3 scripts/insert_images_to_slides.py \
            "slides/${PRESENTATION_NAME}_slide.md" \
            --images-dir "images" \
            --alignment "right" \
            --width "45%" \
            --aspect-ratio "3:4"

          # Copy to presentation directory
          cp "slides/${PRESENTATION_NAME}_slide.md" "presentations/$PRESENTATION_NAME/${PRESENTATION_NAME}_slide_with_images.md"
          cp -r images presentations/$PRESENTATION_NAME/

          # 5. Export slides as individual PNG images using marp
          marp "slides/${PRESENTATION_NAME}_slide.md" \
            -o "presentations/$PRESENTATION_NAME/slide.png" \
            --images png \
            --allow-local-files

          echo "âœ“ Presentation slides generated with Claude"

      - name: Commit slides
        if: success() && (github.event.inputs.generate_video == 'true' || github.event.inputs.generate_slides_only == 'true')
        run: |
          git add presentations/${{ env.PRESENTATION_NAME }}/
          git diff --staged --quiet || git commit -m "Add presentation slides for ${{ env.REPORT_DATE }} (Claude)"
          git pull --rebase origin main || true
          git push origin main

      # ===== è„šæœ¬ç”Ÿæˆï¼ˆClaudeä½¿ç”¨ï¼‰ =====
      - name: Generate script from slides with Claude
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PRESENTATION_DIR="presentations/${{ env.PRESENTATION_NAME }}"
          SLIDE_FILE="$PRESENTATION_DIR/${{ env.PRESENTATION_NAME }}_slide_with_images.md"
          if [ ! -f "$SLIDE_FILE" ]; then
            SLIDE_FILE="$PRESENTATION_DIR/${{ env.PRESENTATION_NAME }}_slide.md"
          fi

          YAML_FILE="inputs/daily_report_${{ env.REPORT_DATE }}.yml"
          if [ -f "$YAML_FILE" ]; then
            python3 scripts/generate_script.py "$SLIDE_FILE" --yaml "$YAML_FILE"
          else
            python3 scripts/generate_script.py "$SLIDE_FILE"
          fi

      # ===== å‹•ç”»ç”Ÿæˆï¼ˆEdge TTS + Remotionï¼‰ =====
      - name: Prepare slide images for video
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          python3 scripts/prepare_slides_for_video.py "presentations/${{ env.PRESENTATION_NAME }}"

      - name: Generate audio
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          python3 scripts/generate_audio.py "$SCRIPT_FILE"

      - name: Generate timings
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          python3 scripts/generate_timings.py "$AUDIO_METADATA"

      - name: Prepare Remotion project
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          cp $AUDIO_DIR/video_timings.json remotion-project/timings.json
          mkdir -p remotion-project/public/presentations/audio_output
          cp $AUDIO_DIR/*.mp3 remotion-project/public/presentations/audio_output/
          mkdir -p remotion-project/public/slides
          cp slide_images/*.png remotion-project/public/slides/
          cp slide_images/slides_metadata.json remotion-project/

      - name: Render video
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          cd remotion-project && npm run build
          echo "âœ“ Video generated"

      - name: Save Video Output
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          mkdir -p videos/${{ env.PRESENTATION_NAME }}
          cp remotion-project/out/video.mp4 videos/${{ env.PRESENTATION_NAME }}/
          cp $AUDIO_DIR/video_timings.json videos/${{ env.PRESENTATION_NAME }}/

      - name: Commit video files
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        run: |
          git add videos/${{ env.PRESENTATION_NAME }}/
          git diff --staged --quiet || git commit -m "feat: Add video - ${{ env.PRESENTATION_NAME }} (Claude)"
          git pull --rebase origin main || true
          git push origin main

      - name: Upload reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-claude-${{ env.REPORT_DATE }}
          path: |
            output/articles.json
            output/stock_prices.json
            output/market_report.md
            output/market_report_${{ env.REPORT_DATE }}.html
            output/market_report_${{ env.REPORT_DATE }}.pdf
            output/portfolio_impact_report.md
            output/portfolio_impact_report_${{ env.REPORT_DATE }}.html
            output/portfolio_impact_report_${{ env.REPORT_DATE }}.pdf
          retention-days: 30

      - name: Upload video as artifact
        if: success() && github.event.inputs.generate_video == 'true' && github.event.inputs.generate_slides_only != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: video-claude-${{ env.REPORT_DATE }}
          path: videos/${{ env.PRESENTATION_NAME }}/video.mp4
          retention-days: 30

      - name: Summary
        run: |
          echo "## Daily Report Generated with Claude! ğŸ¤–" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**AI Engine Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "| Task | AI Engine |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| News Collection | RSS/Web |" >> $GITHUB_STEP_SUMMARY
          echo "| Market Analysis | **Claude** |" >> $GITHUB_STEP_SUMMARY
          echo "| Portfolio Impact | **Claude** |" >> $GITHUB_STEP_SUMMARY
          echo "| Slide Creation | **Claude** |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Generation | Gemini |" >> $GITHUB_STEP_SUMMARY
          echo "| Script Writing | **Claude** |" >> $GITHUB_STEP_SUMMARY
          echo "| Video Rendering | Edge TTS + Remotion |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          python -c "
          import requests, json
          from datetime import datetime
          requests.post('${{ secrets.DISCORD_WEBHOOK_URL }}', json={
            'embeds': [{
              'title': 'âš ï¸ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼ (Claude)',
              'description': 'Claude APIã‚’ä½¿ç”¨ã—ãŸæ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚',
              'color': 15158332,
              'timestamp': datetime.utcnow().isoformat()
            }]
          })
          "
