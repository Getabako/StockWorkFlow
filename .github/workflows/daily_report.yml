name: Daily AI/IT Stock News Report

on:
  schedule:
    # æœˆæ›œæ—¥ã‹ã‚‰é‡‘æ›œæ—¥ JST 6:00 (UTC 21:00) ã«å®Ÿè¡Œ
    - cron: '0 21 * * 1-5'
  workflow_dispatch:
    inputs:
      generate_video:
        description: 'å‹•ç”»ç”Ÿæˆã¾ã§å®Ÿè¡Œ'
        required: false
        type: boolean
        default: true
      generate_slides_only:
        description: 'ã‚¹ãƒ©ã‚¤ãƒ‰ã®ã¿ç”Ÿæˆï¼ˆå‹•ç”»ãªã—ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  daily-report:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: remotion-project/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node dependencies
        run: npm install
        working-directory: ./remotion-project

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Install Japanese fonts
        run: |
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

      - name: Fetch news data
        run: |
          python scripts/fetch_data.py
        env:
          TDNET_RSS_URL: ${{ secrets.TDNET_RSS_URL }}

      - name: Fetch stock prices
        run: |
          python scripts/fetch_stock_prices.py

      - name: Generate Market Analysis Report
        run: |
          python scripts/analyze_market.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Generate Portfolio Impact Report
        run: |
          python scripts/analyze_portfolio_impact.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

      - name: Set date variable
        if: success()
        run: |
          echo "REPORT_DATE=$(date +'%Y_%m_%d')" >> $GITHUB_ENV
          echo "Report date: $(date +'%Y_%m_%d')"

      - name: Convert Market Report to HTML/PDF
        if: success()
        run: |
          python scripts/convert_report_to_html.py output/market_report.md output/
          mv output/market_report.html output/market_report_${{ env.REPORT_DATE }}.html
          mv output/market_report.pdf output/market_report_${{ env.REPORT_DATE }}.pdf
          echo "âœ“ Market report converted to HTML/PDF"

      - name: Convert Portfolio Impact Report to HTML/PDF
        if: success()
        run: |
          python scripts/convert_report_to_html.py output/portfolio_impact_report.md output/
          mv output/portfolio_impact_report.html output/portfolio_impact_report_${{ env.REPORT_DATE }}.html
          mv output/portfolio_impact_report.pdf output/portfolio_impact_report_${{ env.REPORT_DATE }}.pdf
          echo "âœ“ Portfolio impact report converted to HTML/PDF"

      - name: Copy reports to report directory
        if: success()
        run: |
          mkdir -p report/daily/market
          mkdir -p report/daily/portfolio
          cp output/market_report_${{ env.REPORT_DATE }}.html report/daily/market/
          cp output/portfolio_impact_report_${{ env.REPORT_DATE }}.html report/daily/portfolio/
          echo "âœ“ Reports copied to report directory"

      - name: Convert Market Report to YAML for SlideMovie
        if: success()
        run: |
          python scripts/convert_report_to_yaml.py output/market_report.md inputs/ ${{ env.REPORT_DATE }}
          echo "âœ“ YAML file created for SlideMovie workflow"

      - name: Commit reports
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add report/daily/
          git add inputs/daily_report_${{ env.REPORT_DATE }}.yml
          git diff --staged --quiet || git commit -m "Add daily reports for ${{ env.REPORT_DATE }} (automated)"
          git pull --rebase origin main || true
          git push origin main

      - name: Send Market Report to Discord
        if: success()
        run: |
          python scripts/send_to_discord.py \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            "ğŸ“Š AI/ITå¸‚å ´ æ—¥æ¬¡æƒ…å‹¢ãƒ¬ãƒãƒ¼ãƒˆ (${{ env.REPORT_DATE }})" \
            "output/market_report.md" \
            "3066993" \
            "output/market_report_${{ env.REPORT_DATE }}.pdf"

      - name: Wait before sending second report
        if: success()
        run: sleep 5

      - name: Send Portfolio Impact Report to Discord
        if: success()
        run: |
          python scripts/send_to_discord.py \
            "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            "ğŸ’¼ ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªå½±éŸ¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆ (${{ env.REPORT_DATE }})" \
            "output/portfolio_impact_report.md" \
            "15844367" \
            "output/portfolio_impact_report_${{ env.REPORT_DATE }}.pdf"

      # ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ»å‹•ç”»ç”Ÿæˆï¼ˆè‡ªå‹•å®Ÿè¡Œæ™‚ã¾ãŸã¯generate_video=trueæ™‚ï¼‰
      - name: Generate Presentation Slides
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true' || github.event.inputs.generate_slides_only == 'true')
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PRESENTATION_NAME="AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_${{ env.REPORT_DATE }}"
          echo "PRESENTATION_NAME=$PRESENTATION_NAME" >> $GITHUB_ENV

          # Create directories
          mkdir -p slides images presentations/$PRESENTATION_NAME/images

          # Copy background image to images directory for Marp
          cp assets/images/slideBackground.png images/

          # 1. Create slide from YAML
          python3 scripts/create_slide.py "inputs/daily_report_${{ env.REPORT_DATE }}.yml"

          # 2. Generate image prompts
          python3 scripts/generate_image_prompts_with_characters.py \
            "slides/${PRESENTATION_NAME}_slide.md" \
            --output "slides/${PRESENTATION_NAME}_imageprompt.csv"

          # 3. Generate images
          python3 scripts/generate_images_from_prompts.py \
            "slides/${PRESENTATION_NAME}_imageprompt.csv" \
            --output-dir "images"

          # 4. Insert images into slides
          python3 scripts/insert_images_to_slides.py \
            "slides/${PRESENTATION_NAME}_slide.md" \
            --images-dir "images" \
            --alignment "right" \
            --width "45%" \
            --aspect-ratio "3:4"

          # Copy to presentation directory
          cp "slides/${PRESENTATION_NAME}_slide.md" "presentations/$PRESENTATION_NAME/${PRESENTATION_NAME}_slide_with_images.md"
          cp -r images presentations/$PRESENTATION_NAME/

          # 5. Export slides as individual PNG images using marp
          marp "slides/${PRESENTATION_NAME}_slide.md" \
            -o "presentations/$PRESENTATION_NAME/slide.png" \
            --images png \
            --allow-local-files

          echo "âœ“ Presentation slides generated"

      - name: Commit slides
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true' || github.event.inputs.generate_slides_only == 'true')
        run: |
          git add presentations/${{ env.PRESENTATION_NAME }}/
          git diff --staged --quiet || git commit -m "Add presentation slides for ${{ env.REPORT_DATE }}"
          git pull --rebase origin main || true
          git push origin main

      # å‹•ç”»ç”Ÿæˆï¼ˆè‡ªå‹•å®Ÿè¡Œæ™‚ã¾ãŸã¯generate_video=trueæ™‚ã€generate_slides_only=falseæ™‚ï¼‰
      - name: Prepare slide images for video
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          python3 scripts/prepare_slides_for_video.py "presentations/${{ env.PRESENTATION_NAME }}"

      - name: Generate script from slides
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          PRESENTATION_DIR="presentations/${{ env.PRESENTATION_NAME }}"
          SLIDE_FILE="$PRESENTATION_DIR/${{ env.PRESENTATION_NAME }}_slide_with_images.md"
          if [ ! -f "$SLIDE_FILE" ]; then
            SLIDE_FILE="$PRESENTATION_DIR/${{ env.PRESENTATION_NAME }}_slide.md"
          fi

          YAML_FILE="inputs/daily_report_${{ env.REPORT_DATE }}.yml"
          if [ -f "$YAML_FILE" ]; then
            python3 scripts/generate_script.py "$SLIDE_FILE" --yaml "$YAML_FILE"
          else
            python3 scripts/generate_script.py "$SLIDE_FILE"
          fi

      - name: Generate audio
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          python3 scripts/generate_audio.py "$SCRIPT_FILE"

      - name: Generate timings
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          python3 scripts/generate_timings.py "$AUDIO_METADATA"

      - name: Prepare Remotion project
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          cp $AUDIO_DIR/video_timings.json remotion-project/timings.json
          mkdir -p remotion-project/public/presentations/audio_output
          cp $AUDIO_DIR/*.mp3 remotion-project/public/presentations/audio_output/
          mkdir -p remotion-project/public/slides
          cp slide_images/*.png remotion-project/public/slides/
          cp slide_images/slides_metadata.json remotion-project/

      - name: Render video
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          cd remotion-project && npm run build
          echo "âœ“ Video generated"

      - name: Save Video Output
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          mkdir -p videos/${{ env.PRESENTATION_NAME }}
          cp remotion-project/out/video.mp4 videos/${{ env.PRESENTATION_NAME }}/
          cp $AUDIO_DIR/video_timings.json videos/${{ env.PRESENTATION_NAME }}/
          cp -r presentations/scripts_output videos/${{ env.PRESENTATION_NAME }}/scripts_output || true
          cp -r $AUDIO_DIR videos/${{ env.PRESENTATION_NAME }}/audio_output || true

      - name: Commit video files
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        run: |
          git add videos/${{ env.PRESENTATION_NAME }}/
          git add presentations/scripts_output/ || true
          git add presentations/audio_output/ || true
          git diff --staged --quiet || git commit -m "feat: Add video - ${{ env.PRESENTATION_NAME }}"
          git pull --rebase origin main || true
          git push origin main

      - name: Upload video to YouTube
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          # YouTubeã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          if [ -n "$YOUTUBE_CLIENT_ID" ] && [ -n "$YOUTUBE_CLIENT_SECRET" ] && [ -n "$YOUTUBE_REFRESH_TOKEN" ]; then
            python3 scripts/upload_to_youtube.py \
              "videos/${{ env.PRESENTATION_NAME }}/video.mp4" \
              --title "AI/ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ ${{ env.REPORT_DATE }}" \
              --description "æœ¬æ—¥ã®AI/ITå¸‚å ´ã®å‹•å‘åˆ†æãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚è©³ç´°ãªãƒ¬ãƒãƒ¼ãƒˆã¯Discordã§é…ä¿¡ä¸­ã€‚" \
              --tags AI IT æ ªå¼æŠ•è³‡ å¸‚å ´åˆ†æ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ è‡ªå‹•ç”Ÿæˆ AIæ´»ç”¨ \
              --playlist "ãƒ‡ã‚¤ãƒªãƒ¼æ ªå¼æŠ•è³‡åˆ†æ" \
              --report-file "output/market_report.md"
            echo "âœ“ YouTube upload completed"
          else
            echo "YouTube credentials not configured, skipping upload"
          fi

      - name: Upload reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-reports-${{ env.REPORT_DATE }}
          path: |
            output/articles.json
            output/stock_prices.json
            output/market_report.md
            output/market_report_${{ env.REPORT_DATE }}.html
            output/market_report_${{ env.REPORT_DATE }}.pdf
            output/portfolio_impact_report.md
            output/portfolio_impact_report_${{ env.REPORT_DATE }}.html
            output/portfolio_impact_report_${{ env.REPORT_DATE }}.pdf
          retention-days: 30

      - name: Upload video as artifact
        if: success() && (github.event_name == 'schedule' || github.event.inputs.generate_video == 'true') && github.event.inputs.generate_slides_only != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ env.REPORT_DATE }}
          path: videos/${{ env.PRESENTATION_NAME }}/video.mp4
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          python -c "
          import requests, json
          from datetime import datetime
          requests.post('${{ secrets.DISCORD_WEBHOOK_URL }}', json={
            'embeds': [{
              'title': 'âš ï¸ æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼',
              'description': 'æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚GitHub Actionsã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
              'color': 15158332,
              'timestamp': datetime.utcnow().isoformat()
            }]
          })
          "
