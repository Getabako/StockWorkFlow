name: 4. Create Video

on:
  workflow_dispatch:
    inputs:
      presentation_name:
        description: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å'
        required: true
        type: choice
        options:
          - 'AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_2025_11_23'
          - 'AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_2025_11_20'

jobs:
  create-video:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: remotion-project/package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Install Node dependencies
        run: npm install
        working-directory: ./remotion-project

      - name: Verify presentation exists
        run: |
          PRESENTATION_DIR="presentations/${{ github.event.inputs.presentation_name }}"
          if [ ! -d "$PRESENTATION_DIR" ]; then
            echo "Error: Presentation not found: $PRESENTATION_DIR"
            echo "Available presentations:"
            ls -la presentations/ || echo "No presentations directory found"
            exit 1
          fi
          echo "PRESENTATION_DIR=$PRESENTATION_DIR" >> $GITHUB_ENV

      - name: Prepare slide images
        run: |
          python3 scripts/prepare_slides_for_video.py ${{ env.PRESENTATION_DIR }}

      - name: Generate script from slides
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ã‚¹ãƒ©ã‚¤ãƒ‰ã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
          SLIDE_FILE="${{ env.PRESENTATION_DIR }}/${{ github.event.inputs.presentation_name }}_slide_with_images.md"
          if [ ! -f "$SLIDE_FILE" ]; then
            SLIDE_FILE="${{ env.PRESENTATION_DIR }}/${{ github.event.inputs.presentation_name }}_slide.md"
          fi

          # YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ã™ï¼ˆscript_notesãŒã‚ã‚‹å ´åˆã«ä½¿ç”¨ï¼‰
          YAML_FILE=""
          # Daily reportã®å ´åˆï¼ˆAI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_YYYY_MM_DDå½¢å¼ï¼‰
          if [[ "${{ github.event.inputs.presentation_name }}" == AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_* ]]; then
            DATE_STR=$(echo "${{ github.event.inputs.presentation_name }}" | sed 's/AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_//')
            YAML_FILE="inputs/daily_report_${DATE_STR}.yml"
          else
            # é€šå¸¸ã®ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
            YAML_FILE="inputs/${{ github.event.inputs.presentation_name }}.yml"
          fi

          # YAMLãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯--yamlã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
          if [ -f "$YAML_FILE" ]; then
            echo "Using YAML file for script_notes: $YAML_FILE"
            python3 scripts/generate_script.py "$SLIDE_FILE" --yaml "$YAML_FILE"
          else
            echo "No YAML file found, generating script with AI"
            python3 scripts/generate_script.py "$SLIDE_FILE"
          fi

      - name: Generate audio
        run: |
          python3 scripts/generate_audio.py "$SCRIPT_FILE"

      - name: Generate timings
        run: |
          python3 scripts/generate_timings.py "$AUDIO_METADATA"

      - name: Prepare Remotion project
        run: |
          # ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
          cp $AUDIO_DIR/video_timings.json remotion-project/timings.json

          # éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆRemotionãŒæœŸå¾…ã™ã‚‹ãƒ‘ã‚¹ã«é…ç½®ï¼‰
          mkdir -p remotion-project/public/presentations/audio_output
          cp $AUDIO_DIR/*.mp3 remotion-project/public/presentations/audio_output/

          # ã‚¹ãƒ©ã‚¤ãƒ‰ç”»åƒã‚’ã‚³ãƒ”ãƒ¼
          mkdir -p remotion-project/public/slides
          cp slide_images/*.png remotion-project/public/slides/

          # ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
          cp slide_images/slides_metadata.json remotion-project/

      - name: Render video
        run: npm run build
        working-directory: ./remotion-project

      - name: Create video output directory
        run: |
          mkdir -p videos/${{ github.event.inputs.presentation_name }}

      - name: Copy video and related files
        run: |
          cp remotion-project/out/video.mp4 videos/${{ github.event.inputs.presentation_name }}/
          cp $AUDIO_DIR/video_timings.json videos/${{ github.event.inputs.presentation_name }}/
          cp -r presentations/scripts_output videos/${{ github.event.inputs.presentation_name }}/scripts_output
          cp -r $AUDIO_DIR videos/${{ github.event.inputs.presentation_name }}/audio_output

      - name: Create safe artifact name
        id: artifact_name
        run: |
          # æ—¥æœ¬èªžã‚’å«ã‚€ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åã‚’ASCIIå®‰å…¨ãªåå‰ã«å¤‰æ›
          SAFE_NAME=$(echo "${{ github.event.inputs.presentation_name }}" | iconv -t ascii//TRANSLIT 2>/dev/null || echo "video")
          SAFE_NAME=$(echo "$SAFE_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARTIFACT_NAME="video_${SAFE_NAME}_${TIMESTAMP}"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV

      - name: Upload video MP4
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}_MP4
          path: videos/${{ github.event.inputs.presentation_name }}/video.mp4

      - name: Upload all video files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}_ALL
          path: videos/${{ github.event.inputs.presentation_name }}/

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit video files
        run: |
          git add videos/${{ github.event.inputs.presentation_name }}/
          git add presentations/scripts_output/ || true
          git add presentations/audio_output/ || true
          git commit -m "feat: Add video - ${{ github.event.inputs.presentation_name }}

          Generated video with character animations and subtitles

          ðŸ¤– Generated by GitHub Actions" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push || echo "Nothing to push"

      - name: Upload to YouTube
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          # YouTubeã®èªè¨¼æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          if [ -n "$YOUTUBE_CLIENT_ID" ] && [ -n "$YOUTUBE_CLIENT_SECRET" ] && [ -n "$YOUTUBE_REFRESH_TOKEN" ]; then
            # æ—¥ä»˜ã‚’æŠ½å‡ºã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ
            DATE_STR=$(echo "${{ github.event.inputs.presentation_name }}" | grep -oE '[0-9]{4}_[0-9]{2}_[0-9]{2}' | sed 's/_/\//g')
            DATE_UNDERSCORE=$(echo "${{ github.event.inputs.presentation_name }}" | grep -oE '[0-9]{4}_[0-9]{2}_[0-9]{2}')
            TITLE="ã€AI ITæ ªå¼ã€‘æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ ${DATE_STR}"

            # ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŽ¢ã™
            REPORT_FILE=""
            if [ -f "output/market_report.md" ]; then
              REPORT_FILE="output/market_report.md"
            fi

            # YouTubeã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            UPLOAD_ARGS=(
              "videos/${{ github.event.inputs.presentation_name }}/video.mp4"
              --title "$TITLE"
              --description "AIãƒ»ITé–¢é€£æ ªå¼ã®æ—¥æ¬¡å¸‚å ´åˆ†æžãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚æœ¬å‹•ç”»ã¯AIã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ã€‚"
              --tags "AI" "IT" "æ ªå¼æŠ•è³‡" "å¸‚å ´åˆ†æž" "æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ" "è‡ªå‹•ç”Ÿæˆ" "AIæ´»ç”¨"
              --privacy public
              --playlist "ãƒ‡ã‚¤ãƒªãƒ¼æ ªå¼æŠ•è³‡åˆ†æž"
            )
            if [ -n "$REPORT_FILE" ]; then
              UPLOAD_ARGS+=(--report-file "$REPORT_FILE")
            fi

            python3 scripts/upload_to_youtube.py "${UPLOAD_ARGS[@]}"
            echo "âœ“ YouTube upload completed"
          else
            echo "YouTube credentials not configured, skipping upload"
          fi

      - name: Summary
        run: |
          echo "## Video Creation Complete! ðŸŽ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Presentation:** ${{ github.event.inputs.presentation_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARTIFACT_NAME }}_MP4\` - Final video (ready to use)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARTIFACT_NAME }}_ALL\` - All files including scripts and audio" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files saved to repository:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`videos/${{ github.event.inputs.presentation_name }}/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
          echo "- Video with character animations" >> $GITHUB_STEP_SUMMARY
          echo "- Subtitles and timing data" >> $GITHUB_STEP_SUMMARY
          echo "- Audio files" >> $GITHUB_STEP_SUMMARY
          echo "- Script data" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Features:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Slide images as background" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Talk animation when speaking (talk1-6)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Idle animation when not speaking (idle1-6)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auto-generated subtitles" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AI-generated script" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Text-to-speech audio" >> $GITHUB_STEP_SUMMARY
