name: 2. Generate Presentation Images

on:
  workflow_dispatch:
    inputs:
      presentation_name:
        description: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å'
        required: true
        type: choice
        options:
          - 'AI_ITæ ªå¼æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ_2025_11_20'
      image_aspect_ratio:
        description: 'ç”»åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”'
        required: false
        type: choice
        options:
          - '3:4'
          - '16:9'
          - '4:3'
        default: '3:4'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-images:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python dependencies
        run: |
          pip install google-genai google-generativeai pillow pyyaml

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Find presentation file
        id: find_presentation
        run: |
          # ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
          PRES_DIR="presentations/${{ github.event.inputs.presentation_name }}"

          if [ ! -d "$PRES_DIR" ]; then
            echo "Error: Presentation directory not found: $PRES_DIR"
            exit 1
          fi

          echo "Found presentation directory: $PRES_DIR"

          # .mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
          MD_FILE=$(find "$PRES_DIR" -maxdepth 1 -name "*.md" -type f | head -1)

          if [ -z "$MD_FILE" ]; then
            echo "Error: No markdown file found in $PRES_DIR"
            exit 1
          fi

          echo "Found presentation file: $MD_FILE"
          echo "MD_FILE=$MD_FILE" >> $GITHUB_ENV
          echo "PRES_DIR=$PRES_DIR" >> $GITHUB_ENV

      - name: Check or create images directory
        run: |
          IMAGES_DIR="${{ env.PRES_DIR }}/images"
          mkdir -p "$IMAGES_DIR"
          echo "IMAGES_DIR=$IMAGES_DIR" >> $GITHUB_ENV

      - name: Clean existing images
        run: |
          IMAGES_DIR="${{ env.IMAGES_DIR }}"

          # .gitkeepä»¥å¤–ã®å…¨ç”»åƒã‚’å‰Šé™¤
          find "$IMAGES_DIR" -type f -name "*.png" ! -name ".gitkeep" -delete || echo "No images to delete"

          echo "Cleaned images directory: $IMAGES_DIR"

      - name: Generate image prompts
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹ã‚’åˆ†æã—ã¦è©³ç´°ãªç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          python3 scripts/generate_image_prompts_with_characters.py \
            "${{ env.MD_FILE }}"

          echo "Generated image prompts CSV: ${{ env.PRES_DIR }}/ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ.csv"

      - name: Generate images from prompts
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆCSVã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ
          python3 scripts/generate_images_from_prompts.py \
            "${{ env.PRES_DIR }}/ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ.csv" \
            --output-dir "${{ env.IMAGES_DIR }}"

      - name: Upload generated images as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-images
          path: ${{ env.IMAGES_DIR }}/*.png
          if-no-files-found: warn

      - name: Remove old image references
        run: |
          python3 -c "
          import re

          md_file = '${{ env.MD_FILE }}'

          with open(md_file, 'r', encoding='utf-8') as f:
              content = f.read()

          # Remove all image references that match the pattern
          cleaned = re.sub(r'!\[bg (right|left):\d+%\]\(images/[^\)]+\)\n?', '', content)

          with open(md_file, 'w', encoding='utf-8') as f:
              f.write(cleaned)

          print('âœ“ Removed all old image references')
          "
          echo "Old image references removed"

      - name: Update markdown with image references
        run: |
          # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã«ç”»åƒã‚’æŒ¿å…¥
          python3 scripts/insert_images_to_slides.py \
            "${{ env.MD_FILE }}" \
            --images-dir "${{ env.IMAGES_DIR }}" \
            --alignment "right" \
            --width "45%" \
            --aspect-ratio "${{ github.event.inputs.image_aspect_ratio }}"

      - name: Generate preview PDF
        run: |
          marp "${{ env.MD_FILE }}" \
            -o "${{ env.PRES_DIR }}/preview.pdf" \
            --pdf \
            --allow-local-files

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit changes
        run: |
          git add "${{ env.PRES_DIR }}/"

          git commit -m "feat: Generate and insert images for ${{ github.event.inputs.presentation_name }}

          - Generated detailed prompts with character support
          - Used image-to-image for character scenes
          - Aspect ratio: ${{ github.event.inputs.image_aspect_ratio }}
          - Images directory: ${{ env.IMAGES_DIR }}
          - Preview PDF: ${{ env.PRES_DIR }}/preview.pdf

          ğŸ¤– Generated by GitHub Actions" || echo "No changes to commit"

          git push || echo "Nothing to push"

      - name: Upload preview as artifact
        uses: actions/upload-artifact@v4
        with:
          name: presentation-preview
          path: ${{ env.PRES_DIR }}/preview.pdf
