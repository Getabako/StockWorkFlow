name: 1. Generate Presentation

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: 'å…¥åŠ›YAMLãƒ•ã‚¡ã‚¤ãƒ«'
        required: true
        type: choice
        options:
          - 'daily_report_2025_11_27.yml'
          - 'daily_report_2025_11_26.yml'
          - 'daily_report_2025_11_25.yml'
          - 'daily_report_2025_11_24.yml'
          - 'daily_report_2025_11_23.yml'
          - 'daily_report_2025_11_20.yml'
          - 'ai_industry_trends_2025.yml'
          - 'çŸ¥èƒ½æ¤œæŸ»ã‚±ãƒ¼ã‚¹ã‚¹ã‚¿ãƒ‡ã‚£.yml'
      generate_images:
        description: 'ç”»åƒã‚‚ç”Ÿæˆã™ã‚‹'
        required: false
        type: boolean
        default: true
  push:
    paths:
      - 'inputs/*.yml'

jobs:
  generate-presentation:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python dependencies
        run: |
          pip install pyyaml google-generativeai google-genai pillow

      - name: Install Japanese fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Determine input file and image generation option
        id: input
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "INPUT_FILE=inputs/${{ github.event.inputs.input_file }}" >> $GITHUB_ENV
            echo "GENERATE_IMAGES=${{ github.event.inputs.generate_images }}" >> $GITHUB_ENV
          else
            # Get changed files from the latest commit
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only -r HEAD | grep '^inputs/.*\.yml$' | head -1)
            if [ -z "$CHANGED_FILES" ]; then
              echo "No input YAML file changed in the latest commit"
              echo "Checking for any YAML files in inputs/ directory..."
              CHANGED_FILES=$(ls -t inputs/*.yml 2>/dev/null | head -1)
              if [ -z "$CHANGED_FILES" ]; then
                echo "Error: No YAML files found in inputs/ directory"
                exit 1
              fi
              echo "Using most recent file: $CHANGED_FILES"
            fi
            echo "INPUT_FILE=$CHANGED_FILES" >> $GITHUB_ENV
            echo "GENERATE_IMAGES=true" >> $GITHUB_ENV
          fi
          echo "Using input file: $INPUT_FILE"
          echo "Generate images: $GENERATE_IMAGES"

      - name: Get topic name
        id: topic
        run: |
          TOPIC=$(python3 -c "
          import yaml, sys
          with open('${{ env.INPUT_FILE }}', 'r', encoding='utf-8') as f:
              data = yaml.safe_load(f)
              topic = data.get('topic', 'presentation')
              safe_topic = topic.replace(' ', '_').replace('/', '_').replace('\\\\', '_')
              print(safe_topic)
          ")
          echo "TOPIC_NAME=$TOPIC" >> $GITHUB_ENV

      - name: Create directories
        run: |
          mkdir -p slides
          mkdir -p images
          mkdir -p output
          mkdir -p presentations/${{ env.TOPIC_NAME }}
          mkdir -p presentations/${{ env.TOPIC_NAME }}/images

      - name: Copy background image
        run: |
          # èƒŒæ™¯ç”»åƒã‚’imagesãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼
          cp assets/images/slideBackground.png images/
          echo "Copied background image to images/"

      - name: Step 1 - Create slide (text only)
        run: |
          python3 scripts/create_slide.py ${{ env.INPUT_FILE }}
          echo "Created slide: slides/${{ env.TOPIC_NAME }}_slide.md"

      - name: Step 2 - Generate image prompts
        if: env.GENERATE_IMAGES == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ã‚¹ãƒ©ã‚¤ãƒ‰å†…å®¹ã‚’åˆ†æžã—ã¦è©³ç´°ãªç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          python3 scripts/generate_image_prompts_with_characters.py \
            "slides/${{ env.TOPIC_NAME }}_slide.md" \
            --output "slides/${{ env.TOPIC_NAME }}_imageprompt.csv"

          echo "Generated image prompts: slides/${{ env.TOPIC_NAME }}_imageprompt.csv"

      - name: Step 3 - Generate images
        if: env.GENERATE_IMAGES == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆCSVã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ
          python3 scripts/generate_images_from_prompts.py \
            "slides/${{ env.TOPIC_NAME }}_imageprompt.csv" \
            --output-dir "images"

          echo "Generated images:"
          ls -la images/ || echo "No images directory"

      - name: Step 4 - Remove old image references
        if: env.GENERATE_IMAGES == 'true'
        run: |
          python3 -c "
          import re

          md_file = 'slides/${{ env.TOPIC_NAME }}_slide.md'

          with open(md_file, 'r', encoding='utf-8') as f:
              content = f.read()

          # Remove all image references that match the pattern
          cleaned = re.sub(r'!\[bg (right|left):\d+%\]\(images/[^\)]+\)\n?', '', content)

          with open(md_file, 'w', encoding='utf-8') as f:
              f.write(cleaned)

          print('âœ“ Removed all old image references')
          "

      - name: Step 5 - Embed images in slides
        if: env.GENERATE_IMAGES == 'true'
        run: |
          python3 scripts/insert_images_to_slides.py \
            "slides/${{ env.TOPIC_NAME }}_slide.md" \
            --images-dir "images" \
            --alignment "right" \
            --width "45%" \
            --aspect-ratio "3:4"

          # Rename to _with_images for consistency
          cp "slides/${{ env.TOPIC_NAME }}_slide.md" "slides/${{ env.TOPIC_NAME }}_slide_with_images.md"

          echo "Embedded images into slides"

      - name: Step 6 - Convert to HTML and PDF
        run: |
          if [ "${{ env.GENERATE_IMAGES }}" == "true" ]; then
            SLIDE_FILE="slides/${{ env.TOPIC_NAME }}_slide_with_images.md"
          else
            SLIDE_FILE="slides/${{ env.TOPIC_NAME }}_slide.md"
          fi

          marp "$SLIDE_FILE" -o "output/${{ env.TOPIC_NAME }}.html" --html --allow-local-files
          marp "$SLIDE_FILE" -o "output/${{ env.TOPIC_NAME }}.pdf" --pdf --allow-local-files

          echo "Generated HTML and PDF"

      - name: Step 7 - Export slides as individual images
        run: |
          if [ "${{ env.GENERATE_IMAGES }}" == "true" ]; then
            SLIDE_FILE="slides/${{ env.TOPIC_NAME }}_slide_with_images.md"
          else
            SLIDE_FILE="slides/${{ env.TOPIC_NAME }}_slide.md"
          fi

          marp "$SLIDE_FILE" -o "presentations/${{ env.TOPIC_NAME }}/slide.png" --images png --allow-local-files

      - name: Copy files to presentation directory
        run: |
          cp ${{ env.INPUT_FILE }} presentations/${{ env.TOPIC_NAME }}/input.yml
          cp slides/${{ env.TOPIC_NAME }}_slide.md presentations/${{ env.TOPIC_NAME }}/

          if [ "${{ env.GENERATE_IMAGES }}" == "true" ]; then
            cp slides/${{ env.TOPIC_NAME }}_slide_with_images.md presentations/${{ env.TOPIC_NAME }}/ || true
            cp slides/${{ env.TOPIC_NAME }}_imageprompt.csv presentations/${{ env.TOPIC_NAME }}/ç”»åƒãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ.csv || true
            cp -r images presentations/${{ env.TOPIC_NAME }}/
          fi

          cp output/${{ env.TOPIC_NAME }}.html presentations/${{ env.TOPIC_NAME }}/
          cp output/${{ env.TOPIC_NAME }}.pdf presentations/${{ env.TOPIC_NAME }}/

      - name: Create safe artifact name
        id: artifact_name
        run: |
          # æ—¥æœ¬èªžã‚’å«ã‚€ãƒˆãƒ”ãƒƒã‚¯åã‚’ASCIIå®‰å…¨ãªåå‰ã«å¤‰æ›
          SAFE_NAME=$(echo "${{ env.TOPIC_NAME }}" | iconv -t ascii//TRANSLIT 2>/dev/null || echo "presentation")
          SAFE_NAME=$(echo "$SAFE_NAME" | sed 's/[^a-zA-Z0-9_-]/_/g')
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          ARTIFACT_NAME="presentation_${SAFE_NAME}_${TIMESTAMP}"
          echo "ARTIFACT_NAME=$ARTIFACT_NAME" >> $GITHUB_ENV

      - name: Upload PDF presentation
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}_PDF
          path: output/${{ env.TOPIC_NAME }}.pdf

      - name: Upload HTML presentation
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}_HTML
          path: output/${{ env.TOPIC_NAME }}.html

      - name: Upload all presentation files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}_ALL
          path: presentations/${{ env.TOPIC_NAME }}/

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update presentation index
        run: |
          python3 scripts/generate_index.py

      - name: Update workflow options with new presentation
        run: |
          PRES_NAME="${{ env.TOPIC_NAME }}"

          # Update workflows 2, 3, 4 with the new presentation option
          for WORKFLOW in "2-generate-presentation-images.yml" "3-insert-images-to-slides.yml" "4-create-video.yml"; do
            WORKFLOW_FILE=".github/workflows/$WORKFLOW"

            if [ -f "$WORKFLOW_FILE" ]; then
              # Check if the presentation is already in the options
              if ! grep -q "'$PRES_NAME'" "$WORKFLOW_FILE"; then
                # Find the first option line and add after it
                sed -i "s/options:/options:\n          - '$PRES_NAME'/" "$WORKFLOW_FILE"
                echo "âœ“ Added $PRES_NAME to $WORKFLOW"
              else
                echo "âœ“ $PRES_NAME already exists in $WORKFLOW"
              fi
            fi
          done

      - name: Commit presentation files
        run: |
          git add presentations/${{ env.TOPIC_NAME }}/
          git add slides/ || true
          git add images/ || true
          git add presentations.json || true
          git add .github/workflows/*.yml || true

          if [ "${{ env.GENERATE_IMAGES }}" == "true" ]; then
            COMMIT_MSG="feat: Add presentation with images - ${{ env.TOPIC_NAME }}"
          else
            COMMIT_MSG="feat: Add presentation (text only) - ${{ env.TOPIC_NAME }}"
          fi

          git commit -m "$COMMIT_MSG

          Generated from ${{ env.INPUT_FILE }}
          Images: ${{ env.GENERATE_IMAGES }}

          ðŸ¤– Generated by GitHub Actions" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push || echo "Nothing to push"

      - name: Summary
        run: |
          echo "## Presentation Generated! ðŸŽ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ env.TOPIC_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Images Generated:** ${{ env.GENERATE_IMAGES }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ View Online" >> $GITHUB_STEP_SUMMARY
          echo "[Open Presentation Gallery](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Files" >> $GITHUB_STEP_SUMMARY
          echo "- [Download HTML](https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/raw/main/presentations/${{ env.TOPIC_NAME }}/${{ env.TOPIC_NAME }}.html)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download PDF](https://github.com/${{ github.repository_owner }}/${{ github.event.repository.name }}/raw/main/presentations/${{ env.TOPIC_NAME }}/${{ env.TOPIC_NAME }}.pdf)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Generated Files:**" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.GENERATE_IMAGES }}" == "true" ]; then
            echo "- Markdown slides with images" >> $GITHUB_STEP_SUMMARY
            echo "- AI-generated content images (using å¡¾é ­é«˜å´Žç¿”å¤ª character)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Markdown slides (text only)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- HTML presentation" >> $GITHUB_STEP_SUMMARY
          echo "- PDF presentation" >> $GITHUB_STEP_SUMMARY
          echo "- Individual slide images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download Artifacts:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARTIFACT_NAME }}_PDF\` - PDF presentation (ready to use)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARTIFACT_NAME }}_HTML\` - HTML presentation (ready to use)" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.ARTIFACT_NAME }}_ALL\` - All files including slide images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files saved to repository:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`presentations/${{ env.TOPIC_NAME }}/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ env.GENERATE_IMAGES }}" != "true" ]; then
            echo "**Next Step:**" >> $GITHUB_STEP_SUMMARY
            echo "Run workflow '2. Generate Presentation Images' to add images to this presentation" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Next Step:**" >> $GITHUB_STEP_SUMMARY
            echo "Run workflow '4. Create Video' with presentation name: \`${{ env.TOPIC_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          fi
